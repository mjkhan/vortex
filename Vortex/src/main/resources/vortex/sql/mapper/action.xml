<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="action">

<resultMap id="actionRow" type="action">
	<id property="id" column="ACT_ID"/>
	<result property="groupID" column="GRP_ID"/>
	<result property="name" column="ACT_NAME"/>
	<result property="path" column="ACT_PATH"/>
	<result property="description" column="DESCRP"/>
	<result property="modifiedBy" column="UPD_ID"/>
	<result property="lastModified" column="UPD_TIME"/>
	<result property="status" column="STATUS"/>
</resultMap>
	
<!-- 그룹별 액션 목록 가져오기 -->
<select id="getActions" parameterType="string" resultType="dataobject">
SELECT * FROM TBL_ACTION
WHERE GRP_ID = #{groupID}
ORDER BY ACT_ID
</select>

<sql id="select-by-id">
SELECT *
FROM TBL_ACTION
WHERE ACT_ID = #{actionID}
</sql>

<!-- 액션 정보 가져오기 -->
<select id="getInfo" parameterType="string" resultType="dataobject">
<include refid="select-by-id"/>
</select>
	
<!-- Action 가져오기 -->
<select id="getAction" parameterType="string" resultMap="actionRow">
<include refid="select-by-id"/>
</select>
	
<!-- Action 찾기 -->
<select id="findAction" parameterType="string" resultMap="actionRow">
SELECT *
FROM TBL_ACTION
WHERE ACT_PATH = #{actionPath}
</select>

<!-- 액션 정보 생성 -->
<insert id="insert" parameterType="hashmap">
<selectKey keyProperty="action.id" resultType="string" order="BEFORE">
SELECT LPAD(IFNULL((CAST(MAX(ACT_ID) AS UNSIGNED) + 1), 1), 5, '0') NEW_ID
FROM TBL_ACTION;
</selectKey>
INSERT INTO TBL_ACTION (
	ACT_ID
   ,GRP_ID
   ,ACT_NAME
   ,ACT_PATH
   ,DESCRP
   ,UPD_ID
   ,UPD_TIME
   ,STATUS
) VALUES (
	#{action.id}
   ,#{action.groupID}
   ,#{action.name}
   ,#{action.path}
   ,#{action.description}
   ,#{currentUser.id}
   ,CURRENT_TIMESTAMP
   ,'001'
)
</insert>

<!-- 액션 정보 수정 -->
<update id="update" parameterType="hashmap">
UPDATE TBL_ACTION SET
	ACT_NAME = #{action.name}
   ,ACT_PATH = #{action.path}
   ,DESCRP = #{action.description}
   ,UPD_ID = #{currentUser.id}
   ,UPD_TIME = CURRENT_TIMESTAMP
WHERE ACT_ID = #{action.id}
</update>

<!-- 액션 상태 변경 -->
<update id="setStatus" parameterType="hashmap">
UPDATE TBL_ACTION SET
	STATUS = #{status}
   ,UPD_ID = #{currentUser.id}
   ,UPD_TIME = CURRENT_TIMESTAMP
WHERE 1 = 1
<if test="groupID != null">
AND GRP_ID = #{groupID}
</if>
<if test="actionIDs != null">
AND ACT_ID IN (<foreach collection="actionIDs" item="actionID" separator=", ">#{actionID}</foreach>)
</if>
</update>

<!-- groupID의 액션 정보를 삭제 -->
<delete id="delete" parameterType="hashmap">
DELETE FROM TBL_ACTION
WHERE 1 = 1
<if test="groupIDs != null">
AND GRP_ID IN (<foreach collection="groupIDs" item="groupID" separator=", ">#{groupID}</foreach>)
</if>
<if test="actionIDs != null">
AND ACT_ID IN (<foreach collection="actionIDs" item="actionID" separator=", ">#{actionID}</foreach>)
</if>
</delete>

</mapper>